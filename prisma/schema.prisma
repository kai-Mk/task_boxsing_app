// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String    @id @default(nanoid())
  name               String
  email              String    @unique
  passwordHash       String?   // nullable for Google OAuth users
  lastSelectedTeamId String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime? // soft delete

  // Relations
  accounts              Account[]
  teamMembers           TeamMember[]
  ownedTeams            Team[]           @relation("TeamOwner")
  sentMeetingRequests   MeetingRequest[] @relation("MeetingRequester")
  receivedMeetingRequests MeetingRequest[] @relation("MeetingTarget")
  createdInvitations    TeamInvitation[]

  @@map("users")
}

model Account {
  id                String  @id @default(nanoid())
  userId            String
  provider          String  // "credentials", "google", etc.
  providerAccountId String  // external ID (Google sub, etc.)
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?
  tokenType         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Team {
  id          String    @id @default(nanoid())
  name        String
  description String?
  ownerId     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // soft delete

  // Relations
  owner            User             @relation("TeamOwner", fields: [ownerId], references: [id])
  teamMembers      TeamMember[]
  meetingRequests  MeetingRequest[]
  invitations      TeamInvitation[]

  @@map("teams")
}

model TeamMember {
  id        String    @id @default(nanoid())
  teamId    String
  userId    String
  role      TeamRole  @default(MEMBER)
  createdAt DateTime  @default(now())
  deletedAt DateTime? // soft delete

  // Relations
  team      Team                     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  positions TeamMemberPosition[]
  tasks     Task[]

  @@unique([teamId, userId])
  @@map("team_members")
}

model Position {
  id        String   @id @default(nanoid())
  name      String   @unique // "FE", "BE", "QA", etc.
  label     String   // display name
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teamMemberPositions TeamMemberPosition[]

  @@map("positions")
}

model TeamMemberPosition {
  id           String @id @default(nanoid())
  teamMemberId String
  positionId   String

  // Relations
  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)
  position   Position   @relation(fields: [positionId], references: [id], onDelete: Cascade)

  @@unique([teamMemberId, positionId])
  @@map("team_member_positions")
}

model Task {
  id              String            @id @default(nanoid())
  teamMemberId    String
  date            DateTime          @db.Date
  title           String
  description     String?
  startTime       Int               // minutes from midnight (e.g., 540 = 09:00)
  endTime         Int               // minutes from midnight (e.g., 600 = 10:00)
  type            TaskType          @default(WORK)
  status          TaskStatus        @default(TODO)
  color           TaskColor         @default(BLUE)
  mtgAvailability MtgAvailability   @default(AVAILABLE)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?         // soft delete

  // Relations
  teamMember TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model MeetingRequest {
  id              String                @id @default(nanoid())
  teamId          String
  requesterId     String
  targetId        String
  date            DateTime              @db.Date
  startTime       Int                   // minutes from midnight (e.g., 840 = 14:00)
  endTime         Int                   // minutes from midnight (e.g., 900 = 15:00)
  requestMessage  String
  responseMessage String?
  cancelMessage   String?
  status          MeetingRequestStatus  @default(PENDING)
  respondedAt     DateTime?
  canceledAt      DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  deletedAt       DateTime?             // soft delete

  // Relations
  team      Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  requester User @relation("MeetingRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  target    User @relation("MeetingTarget", fields: [targetId], references: [id], onDelete: Cascade)

  @@map("meeting_requests")
}

model TeamInvitation {
  id              String    @id @default(nanoid())
  teamId          String
  code            String    @unique
  expiresAt       DateTime?
  maxUses         Int?      // nullable = unlimited
  usedCount       Int       @default(0)
  createdByUserId String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime? // soft delete

  // Relations
  team      Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdBy User @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)

  @@map("team_invitations")
}

// Enums
enum TeamRole {
  ADMIN
  MEMBER
}

enum TaskType {
  WORK
  BREAK
}

enum TaskStatus {
  TODO
  DONE
}

enum TaskColor {
  RED
  ORANGE
  YELLOW
  GREEN
  BLUE
  PURPLE
  PINK
  GRAY
}

enum MtgAvailability {
  AVAILABLE
  CHAT_ONLY
  UNAVAILABLE
}

enum MeetingRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELED
}
